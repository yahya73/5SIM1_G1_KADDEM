pipeline {
    agent any
    environment {
                GRAFANA_API_KEY = credentials('sa-salim')
                GRAFANA_URL = 'http://192.168.50.4:3000'
                PROMETHEUS_URL = 'http://localhost:9090'
            }
        tools {
            jdk 'JAVA_HOME'
            maven 'M2_HOME'
        }

    stages {
        stage('Hello') {
            steps {
                echo 'Hello World'
            }
        }

        stage('Git') {
            steps {
                git branch: 'salim', changelog: false, poll: false, url: 'https://github.com/yahya73/KADDEM_DEVOPS.git'
            }
        }
        stage('Testing Maven') {
                    steps {
                        sh 'mvn -version'
                    }
        }


             stage('Build') {
                 steps {
                     sh 'mvn clean install -DskipITs'
                 }
             }
              stage('Display Date') {
                         steps {
                             script {
                                 def currentDate = new Date()
                                 echo "Current Date: ${currentDate}"
                             }
                         }
                }
              stage('Mockito') {
                     steps {
                     echo 'Running Maven tests...'
                        sh 'mvn test'
                     }
                    }

             stage ('SonarQube') {

                                 steps {

                                     sh 'mvn sonar:sonar -Dsonar.token=squ_eb520a8a5badd7b20b96263dd6648bf681aab8a4  -Dmaven.test.skip=true';

                                 }

                             }
                             stage ('Nexus') {
                                 steps {
                                     sh 'mvn clean deploy -DskipTests -Dusername=admin -Dpassword=nexus'
                                       }
                             }
                             stage ('dockercompose') {
                                 steps {
                                       sh 'docker compose down '
                                       sh 'docker compose up -d'
                                                  }
                                 }
                              stage('Use Existing Grafana Dashboard') {
                                         steps {
                                         echo "Grafana dashboard for monitoring available at: $http://192.168.33.10:3000/d/haryan-jenkins/jenkins3a-performance-and-health-overview"
                                              }
                                         }



    }
post {
        success {
            emailext(
                subject: "SUCCESS: Build #${currentBuild.number} - ${currentBuild.fullDisplayName}",
                body: """
                    <h2>Build Successful!</h2>
                    <p>The build was successful!</p>
<p>Check it out here: <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
                    <p>Commit: <strong>${env.GIT_COMMIT}</strong></p>
                    <p>Branch: <strong>${env.GIT_BRANCH}</strong></p>
                    <p>Duration: <strong>${currentBuild.durationString}</strong></p>
                """,
                to: 'salim.rabbaoui@esprit.tn',
                mimeType: 'text/html' // Use HTML for better formatting
            )
        }
        failure {
            emailext(
                subject: "FAILED: Build #${currentBuild.number} - ${currentBuild.fullDisplayName}",
                body: """
                    <h2>Build Failed!</h2>
                    <p>The build has failed.</p>
                    <p>Check the logs here: <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
                    <p>Commit: <strong>${env.GIT_COMMIT}</strong></p>
                    <p>Branch: <strong>${env.GIT_BRANCH}</strong></p>
                    <p>Triggered by: <strong>${currentBuild.getCause(hudson.model.Cause$PushCause)?.shortDescription ?: 'N/A'}</strong></p>
                """,
                to: 'salim.rabbaoui@esprit.tn',
                mimeType: 'text/html' // Use HTML for better formatting
            )
        }
    }
}



}