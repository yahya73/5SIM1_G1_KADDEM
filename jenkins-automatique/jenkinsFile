
pipeline {
    agent any
    environment {
                GRAFANA_API_KEY = credentials('grafana-api-key')
                GRAFANA_URL = 'http://192.168.50.4:3000'
                PROMETHEUS_URL = 'http://localhost:9090'
            }
    tools {
            jdk 'JAVA_HOME'
            maven 'M2_HOME'
        }

    stages {
        stage('Hello') {
            steps {
                echo 'Hello World'
            }
        }

        stage('Git') {
            steps {
                git branch: 'salim', changelog: false, poll: false, url: 'https://github.com/yahya73/KADDEM_DEVOPS.git'
            }
        }
        stage('Testing Maven') {
                    steps {
                        sh 'mvn -version'
                    }
        }


             stage('Build') {
                 steps {
                     sh 'mvn clean install -DskipITs'
                 }
             }
              stage('Display Date') {
                         steps {
                             script {
                                 def currentDate = new Date()
                                 echo "Current Date: ${currentDate}"
                             }
                         }
                }

             stage ('SonarQube') {

                                 steps {

                                     sh 'mvn sonar:sonar -Dsonar.token=squ_6a2bf4c90f75473d5bea7a32de4c9055ba35a536  -Dmaven.test.skip=true';

                                 }

                             }
                             stage ('Nexus') {
                                 steps {
                                     sh 'mvn clean deploy -DskipTests -Dusername=admin -Dpassword=nexus'
                                       }
                             }
                             stage ('dockercompose') {
                                                             steps {
                                                                     sh 'docker compose down '
                                                                     sh 'docker compose up -d'
                                                                       }
                                                             }

                                                 stage('CI - Testing Maven') {
                                                           steps {
                                                                     echo 'Running Maven tests...'
                                                                     sh 'mvn test'
                                                                 }
                                                             }
                              stage('Use Existing Grafana Dashboard') {
                                         steps {
                                         echo "Grafana dashboard for monitoring available at: ${GRAFANA_URL}/d/haryan-jenkins/jenkins3a-performance-and-health-overview"
                                              }
                                         }
                                 }

       }

}